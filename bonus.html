<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>魚鮮會社 | 營運績效試算</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            /* 定義品牌色：深海軍藍 */
            --brand-dark: #1e293b; 
            --brand-blue: #334155;
            --brand-accent: #0f172a;
        }
        body { 
            font-family: 'Noto Sans TC', sans-serif; 
            background-color: #f8fafc; /* 極淡的灰白背景 */
            color: #334155;
        }
        /* 極簡卡片風格 */
        .gyosen-card {
            background-color: white;
            border: 1px solid #e2e8f0;
            border-radius: 4px; /* 日式風格通常圓角較小 */
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.05);
        }
        .gyosen-header {
            background-color: var(--brand-dark);
            color: white;
        }
        /* 自定義進度條動畫 */
        .progress-bar {
            transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .loading-overlay { background: rgba(255, 255, 255, 0.98); }
    </style>
</head>
<body class="antialiased">

    <div id="app" class="min-h-screen pb-12">
        
        <div v-if="isLoading" class="fixed inset-0 z-50 flex flex-col items-center justify-center loading-overlay">
            <div class="w-12 h-12 border-4 border-slate-200 border-t-slate-800 rounded-full animate-spin mb-4"></div>
            <p class="text-sm font-medium tracking-widest text-slate-600">DATA SYNCHRONIZING...</p>
        </div>

        <header class="gyosen-header shadow-md">
            <div class="max-w-7xl mx-auto px-6 h-16 flex justify-between items-center">
                <div class="flex items-center space-x-3">
                    <div class="h-6 w-1 bg-white"></div> <h1 class="text-lg font-bold tracking-widest">魚鮮會社 | 營運績效試算</h1>
                </div>
                <button @click="fetchData" class="text-xs border border-slate-500 hover:border-white text-slate-300 hover:text-white px-4 py-1.5 transition duration-300 tracking-wide">
                    數據更新
                </button>
            </div>
        </header>

        <main class="max-w-7xl mx-auto px-6 mt-10 grid grid-cols-1 lg:grid-cols-12 gap-8" v-if="!isLoading">
            
            <div class="lg:col-span-4 space-y-6">
                
                <div class="gyosen-card p-6 border-t-4 border-slate-800">
                    <div class="flex justify-between items-end mb-6 border-b border-slate-100 pb-4">
                        <h2 class="text-base font-bold text-slate-800 tracking-wide">當月營運數據</h2>
                        <span class="text-[10px] text-slate-400 uppercase tracking-wider">Source: Google Sheet</span>
                    </div>
                    
                    <div class="space-y-8">
                        <div>
                            <label class="block text-xs font-medium text-slate-500 mb-2 tracking-wide">實際業績 REVENUE</label>
                            <div class="flex items-baseline">
                                <span class="text-2xl font-bold text-slate-900 mr-2">{{ formatNumber(revenue) }}</span>
                                <span class="text-sm text-slate-500">TWD</span>
                            </div>
                        </div>

                        <div>
                            <div class="flex justify-between text-xs mb-2">
                                <span class="font-medium text-slate-600">食材成本率</span>
                                <span :class="foodCostRate > 40 ? 'text-red-600 font-bold' : 'text-slate-500'">
                                    {{ foodCostRate }}% <span class="text-slate-300">/ 40%</span>
                                </span>
                            </div>
                            <div class="w-full bg-slate-100 h-1.5 overflow-hidden">
                                <div class="h-full progress-bar" 
                                     :style="{ width: Math.min(foodCostRate, 100) + '%' }" 
                                     :class="foodCostRate > 40 ? 'bg-red-700' : 'bg-slate-800'"></div>
                            </div>
                        </div>

                        <div>
                            <div class="flex justify-between text-xs mb-2">
                                <span class="font-medium text-slate-600">人事成本率</span>
                                <span :class="laborCostRate > 28 ? 'text-red-600 font-bold' : 'text-slate-500'">
                                    {{ laborCostRate }}% <span class="text-slate-300">/ 28%</span>
                                </span>
                            </div>
                            <div class="w-full bg-slate-100 h-1.5 overflow-hidden">
                                <div class="h-full progress-bar" 
                                     :style="{ width: Math.min(laborCostRate, 100) + '%' }" 
                                     :class="laborCostRate > 28 ? 'bg-red-700' : 'bg-slate-800'"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="gyosen-card p-6 bg-slate-50 border-none">
                    <h3 class="text-xs font-bold text-slate-400 mb-2 tracking-widest">BONUS TIER</h3>
                    <div class="text-lg font-bold text-slate-800 mb-1">{{ tierName }}</div>
                    <div class="text-sm text-slate-500">超額提撥比例：{{ (currentRate * 100).toFixed(0) }}%</div>
                </div>
            </div>

            <div class="lg:col-span-8 space-y-6">
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="gyosen-card p-5 flex flex-col justify-between">
                        <span class="text-xs font-medium text-slate-400 tracking-wide uppercase">Initial Pool</span>
                        <div class="mt-2 text-2xl font-light text-slate-800">{{ formatCurrency(initialPool) }}</div>
                        <div class="mt-2 h-0.5 w-8 bg-slate-200"></div>
                    </div>

                    <div class="gyosen-card p-5 flex flex-col justify-between">
                        <span class="text-xs font-medium text-slate-400 tracking-wide uppercase">Deduction</span>
                        <div class="mt-2 text-2xl font-light" :class="totalPenalty > 0 ? 'text-red-700' : 'text-slate-300'">
                            -{{ formatCurrency(totalPenalty) }}
                        </div>
                        <div class="mt-2 h-0.5 w-8" :class="totalPenalty > 0 ? 'bg-red-700' : 'bg-slate-200'"></div>
                    </div>

                    <div class="gyosen-card p-5 bg-slate-800 text-white border-slate-800 flex flex-col justify-between">
                        <span class="text-xs font-medium text-slate-400 tracking-wide uppercase">Net Bonus Pool</span>
                        <div class="mt-2 text-3xl font-medium tracking-tight">{{ formatCurrency(finalPool) }}</div>
                        <div class="mt-2 text-[10px] text-slate-400">1 Point = {{ formatCurrency(valuePerPoint) }}</div>
                    </div>
                </div>

                <div class="gyosen-card overflow-hidden">
                    <div class="px-6 py-4 border-b border-slate-100 bg-slate-50">
                        <h3 class="text-sm font-bold text-slate-700 tracking-wide">團隊分配試算 Distribution</h3>
                    </div>
                    <table class="min-w-full divide-y divide-slate-100">
                        <thead class="bg-white">
                            <tr>
                                <th class="px-6 py-3 text-left text-[11px] font-bold text-slate-400 uppercase tracking-wider">職稱 Title</th>
                                <th class="px-6 py-3 text-center text-[11px] font-bold text-slate-400 uppercase tracking-wider">人數 Count</th>
                                <th class="px-6 py-3 text-center text-[11px] font-bold text-slate-400 uppercase tracking-wider">權重 Weight</th>
                                <th class="px-6 py-3 text-right text-[11px] font-bold text-slate-400 uppercase tracking-wider">個人獎金 Individual</th>
                                <th class="px-6 py-3 text-right text-[11px] font-bold text-slate-400 uppercase tracking-wider">小計 Subtotal</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-slate-50 text-sm">
                            <tr v-for="(staff, index) in staffList" :key="index" class="hover:bg-slate-50 transition-colors">
                                <td class="px-6 py-4 whitespace-nowrap font-medium text-slate-700">
                                    <span class="inline-block w-2 h-2 rounded-full mr-2" :class="staff.dept === '內場' ? 'bg-slate-600' : 'bg-slate-300'"></span>
                                    {{ staff.title }}
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-center text-slate-500 font-light">
                                    {{ staff.count }}
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-center text-slate-500 font-light">
                                    {{ staff.weight.toFixed(1) }}
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-right font-medium text-slate-800">
                                    {{ formatCurrency(staff.weight * valuePerPoint) }}
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-right text-slate-400 font-light">
                                    {{ formatCurrency(staff.weight * valuePerPoint * staff.count) }}
                                </td>
                            </tr>
                        </tbody>
                        <tfoot class="bg-slate-50">
                            <tr>
                                <td colspan="4" class="px-6 py-4 text-right text-xs font-bold text-slate-500 uppercase tracking-wide">Total Distributed</td>
                                <td class="px-6 py-4 text-right text-sm font-bold text-slate-800">{{ formatCurrency(totalDistributed) }}</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>

            </div>
        </main>
    </div>

    <script>
        const { createApp, ref, computed, onMounted } = Vue;

        createApp({
            setup() {
                // ==========================================
                // CSV 連結 (已預設為你提供的連結)
                // ==========================================
                const googleSheetUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSj5mhmCmAp62ZmWryBz4__1C7hDx3-S6jI87iPHMQKBy8PhuTMHdsb9xMZnJQhV8L9kTaiBaUQGH8B/pub?gid=1958911966&single=true&output=csv';

                const isLoading = ref(true);
                const revenue = ref(0);
                const foodCostRate = ref(0);
                const laborCostRate = ref(0);

                // 系統參數
                const target = 2100000;
                const foodLimit = 40.0;
                const laborLimit = 28.0;

                // 人員配置
                const staffList = ref([
                    { dept: '內場', title: '料理長', count: 1, weight: 3.0 },
                    { dept: '內場', title: '副料理長', count: 1, weight: 2.0 },
                    { dept: '內場', title: '正職人員', count: 4, weight: 1.0 },
                    { dept: '外場', title: '店長', count: 1, weight: 3.0 },
                    { dept: '外場', title: '副店長', count: 1, weight: 2.0 },
                    { dept: '外場', title: '正職人員', count: 1, weight: 1.0 },
                ]);

                // 抓取數據 (保留精準邏輯)
                const fetchData = () => {
                    isLoading.value = true;
                    const urlWithTimestamp = googleSheetUrl + '&t=' + new Date().getTime();
                    
                    Papa.parse(urlWithTimestamp, {
                        download: true,
                        header: false,
                        complete: function(results) {
                            const rows = results.data;
                            rows.forEach(row => {
                                if (row.length < 2) return;
                                const key = row[0] ? row[0].toString().trim().toLowerCase() : '';
                                const valString = row[1] ? row[1].toString().replace(/,/g, '').replace(/%/g, '') : '0';
                                const val = parseFloat(valString);
                                if (isNaN(val)) return;

                                if (key === 'revenue' || key === '業績') revenue.value = val;
                                if (key === 'food' || key === 'foodrate' || key.includes('食材')) foodCostRate.value = val;
                                if (key === 'labor' || key === 'laborrate' || key.includes('人事')) laborCostRate.value = val;
                            });
                            setTimeout(() => { isLoading.value = false; }, 600);
                        },
                        error: function() { isLoading.value = false; }
                    });
                };

                onMounted(() => { fetchData(); });

                // 計算邏輯
                const currentTier = computed(() => {
                    if (revenue.value >= 2500000) return 3;
                    if (revenue.value >= 2300000) return 2;
                    if (revenue.value > 2100000) return 1;
                    return 0;
                });

                const currentRate = computed(() => {
                    if (currentTier.value === 3) return 0.20;
                    if (currentTier.value === 2) return 0.15;
                    if (currentTier.value === 1) return 0.10;
                    return 0;
                });

                const tierName = computed(() => {
                    if (currentTier.value === 3) return "Level 3 - 超級旺季";
                    if (currentTier.value === 2) return "Level 2 - 表現優異";
                    if (currentTier.value === 1) return "Level 1 - 達標門檻";
                    return "未達標";
                });

                const initialPool = computed(() => {
                    const excess = Math.max(0, revenue.value - target);
                    return excess * currentRate.value;
                });

                const totalPenalty = computed(() => {
                    let penalty = 0;
                    if (foodCostRate.value > foodLimit) penalty += revenue.value * ((foodCostRate.value - foodLimit) / 100);
                    if (laborCostRate.value > laborLimit) penalty += revenue.value * ((laborCostRate.value - laborLimit) / 100);
                    return penalty;
                });

                const finalPool = computed(() => {
                    return Math.max(0, initialPool.value - totalPenalty.value);
                });

                const totalPoints = computed(() => {
                    return staffList.value.reduce((sum, staff) => sum + (staff.count * staff.weight), 0);
                });

                const valuePerPoint = computed(() => {
                    if (totalPoints.value === 0) return 0;
                    return finalPool.value / totalPoints.value;
                });

                const totalDistributed = computed(() => {
                    return staffList.value.reduce((sum, staff) => {
                        return sum + (staff.weight * valuePerPoint.value * staff.count);
                    }, 0);
                });

                const formatCurrency = (val) => {
                    return new Intl.NumberFormat('zh-TW', { style: 'currency', currency: 'TWD', maximumFractionDigits: 0 }).format(val);
                };
                
                const formatNumber = (val) => {
                    return new Intl.NumberFormat('zh-TW').format(val);
                }

                return {
                    revenue, foodCostRate, laborCostRate, staffList,
                    tierName, currentRate,
                    initialPool, totalPenalty, finalPool, valuePerPoint, totalPoints,
                    totalDistributed,
                    formatCurrency, formatNumber, isLoading, fetchData
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
