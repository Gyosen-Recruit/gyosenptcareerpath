<script>
        // ================= 設定區 =================
        const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSPKyIVGlT4rmWEOUPwSdccHGWEaGPF3QhMm0rXnh7g_0kJx9iXFzIGVoY_uWOUHN9La8KjZOp5BMAv/pub?gid=1617552127&single=true&output=csv';
        const DATA_CUTOFF_DATE = "2026/01/07"; 
        
        let isDashboardLoaded = false;
        let globalDashboardData = [];

        window.onload = function() {
            loadPart('front-house-content', 'front-house.html');
            loadPart('back-house-content', 'back-house.html');
            if(window.location.hash === '#dashboard') switchTab('dash');
        };

        function loadPart(id, file, callback) {
            fetch(file)
                .then(res => res.text())
                .then(data => {
                    document.getElementById(id).innerHTML = data;
                    if (callback) callback();
                })
                .catch(err => {
                    console.log('載入失敗:', file);
                    document.getElementById(id).innerHTML = `<div class="p-4 text-center text-slate-400">目前無法預覽 ${file} 內容 (Demo Mode)</div>`;
                });
        }

        function switchTab(type) {
            const fBtn = document.getElementById('tab-front');
            const bBtn = document.getElementById('tab-back');
            const dBtn = document.getElementById('tab-dash');
            const fContent = document.getElementById('front-house-content');
            const bContent = document.getElementById('back-house-content');
            const dContent = document.getElementById('dashboard-content');
            const timeline = document.getElementById('common-timeline');
            const dashControls = document.getElementById('dashboard-controls');

            fBtn.className = 'tab-btn inactive';
            bBtn.className = 'tab-btn inactive';
            dBtn.className = 'tab-btn inactive';
            fContent.className = 'content-section';
            bContent.className = 'content-section';
            dContent.className = 'content-section';
            dashControls.classList.add('hidden');

            if (type === 'front') {
                fBtn.className = 'tab-btn active'; fContent.className = 'content-section active'; timeline.style.display = 'block';
            } else if (type === 'back') {
                bBtn.className = 'tab-btn active'; bContent.className = 'content-section active'; timeline.style.display = 'block';
            } else if (type === 'dash') {
                dBtn.className = 'tab-btn dashboard-active'; dContent.className = 'content-section active'; timeline.style.display = 'none';
                
                // Demo 模式下隱藏控制列，正式版才顯示
                if (window.location.href.indexOf('demo') === -1) {
                    dashControls.classList.remove('hidden');
                }
                
                initDashboard();
            }
        }
        
        function initDashboard() {
            if (isDashboardLoaded) return; 

            // ============================================
            // 【核心修改】偵測 Demo 模式，攔截並顯示假資料
            // ============================================
            if (window.location.href.indexOf('demo') !== -1) {
                console.log("進入 Demo 模式：啟用範例資料");
                
                // 1. 修改 UI 文字
                const tabDash = document.getElementById('tab-dash');
                if(tabDash) tabDash.innerText = "時數儀表板"; 
                
                const cutoff = document.getElementById('data-cutoff-display');
                if(cutoff) cutoff.innerHTML = `<i class="fa-regular fa-clock mr-1"></i>資料統計至：範例數據`;
                
                const lastUp = document.getElementById('last-update');
                if(lastUp) lastUp.innerText = ""; 

                // 2. 注入「修正狀態版」的假表格
                const demoHTML = `
                <div class="hidden md:block bg-white rounded-3xl shadow-lg border border-slate-100 overflow-hidden">
                <table class="min-w-full text-left text-sm whitespace-nowrap border-collapse">
                    <thead class="bg-slate-50 border-b border-slate-200 font-black text-slate-600 uppercase tracking-wider sticky top-0 z-10">
                        <tr>
                            <th class="px-6 py-5 pl-8">夥伴姓名</th>
                            <th class="px-6 py-5">目前等級 / 進度</th>
                            <th class="px-6 py-5 text-right text-brand-red">累積時數</th>
                            <th class="px-6 py-5 text-center">考核狀態</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-100">
                        <tr class="bg-amber-50 hover:bg-amber-100 transition-colors border-l-4 border-l-[#B29A1F]">
                            <td class="px-6 py-4 pl-8 font-bold text-base text-slate-900">王Ｏ明 (店長範例)</td>
                            <td class="px-6 py-4">
                                <div class="flex items-center gap-3">
                                    <span class="inline-block px-3 py-0.5 rounded-md border text-xs font-black tracking-wide bg-[#B29A1F] text-white border-[#B29A1F] shadow-sm">L3</span>
                                    <div class="w-full max-w-[220px] h-4 bg-slate-200 rounded-full overflow-hidden shadow-inner">
                                        <div class="h-full bg-[#B29A1F] progress-bar-fill shadow-sm" style="width: 100%"></div>
                                    </div>
                                    <span class="text-xs text-slate-400 font-bold w-10">100%</span>
                                </div>
                            </td>
                            <td class="px-6 py-4 text-right">
                                <span class="font-mono font-black text-xl text-[#B21F2C] tracking-tight">1,280</span>
                                <span class="text-xs text-slate-400 ml-1">/ 600</span>
                            </td>
                            <td class="px-6 py-4 text-center">
                                <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-bold bg-green-100 text-green-700 ring-1 ring-green-600/20"><span class="w-1.5 h-1.5 mr-1.5 bg-green-500 rounded-full animate-pulse"></span>考核中</span>
                            </td>
                        </tr>
                        <tr class="bg-slate-50 hover:bg-blue-50 transition-colors border-l-4 border-l-blue-400">
                            <td class="px-6 py-4 pl-8 font-bold text-base text-slate-800">陳Ｏ豪 (資深範例)</td>
                            <td class="px-6 py-4">
                                <div class="flex items-center gap-3">
                                    <span class="inline-block px-3 py-0.5 rounded-md border text-xs font-black tracking-wide bg-blue-500 text-white border-blue-500 shadow-sm">L2</span>
                                    <div class="w-full max-w-[220px] h-4 bg-slate-200 rounded-full overflow-hidden shadow-inner">
                                        <div class="h-full bg-[#3B82F6] progress-bar-fill shadow-sm" style="width: 94%"></div>
                                    </div>
                                    <span class="text-xs text-slate-400 font-bold w-10">94%</span>
                                </div>
                            </td>
                            <td class="px-6 py-4 text-right">
                                <span class="font-mono font-black text-xl text-[#B21F2C] tracking-tight">425</span>
                                <span class="text-xs text-slate-400 ml-1">/ 450</span>
                            </td>
                            <td class="px-6 py-4 text-center">
                                <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-bold bg-orange-100 text-orange-700 ring-1 ring-orange-600/20">覆核中</span>
                            </td>
                        </tr>
                        <tr class="hover:bg-slate-50 transition-colors bg-white">
                            <td class="px-6 py-4 pl-8 font-bold text-base text-slate-700">林Ｏ婷 (新人範例)</td>
                            <td class="px-6 py-4">
                                <div class="flex items-center gap-3">
                                    <span class="inline-block px-3 py-0.5 rounded-md border text-xs font-black tracking-wide bg-slate-100 text-slate-500 border-slate-200">L1</span>
                                    <div class="w-full max-w-[220px] h-4 bg-slate-200 rounded-full overflow-hidden shadow-inner">
                                        <div class="h-full bg-[#B21F2C] progress-bar-fill shadow-sm" style="width: 57%"></div>
                                    </div>
                                    <span class="text-xs text-slate-400 font-bold w-10">57%</span>
                                </div>
                            </td>
                            <td class="px-6 py-4 text-right">
                                <span class="font-mono font-black text-xl text-[#B21F2C] tracking-tight">86</span>
                                <span class="text-xs text-slate-400 ml-1">/ 150</span>
                            </td>
                            <td class="px-6 py-4 text-center">
                                <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-bold bg-slate-100 text-slate-400">累積中</span>
                            </td>
                        </tr>
                    </tbody>
                </table>
                </div>

                <div class="grid grid-cols-1 gap-4 md:hidden">
                     <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100 relative overflow-hidden">
                        <div class="absolute top-0 left-0 w-1 h-full bg-[#B29A1F]"></div>
                        <div class="flex justify-between items-start mb-4 pl-2">
                            <div>
                                <h3 class="font-bold text-lg text-slate-900">王Ｏ明 (店長範例)</h3>
                                <span class="inline-block mt-1 px-2 py-0.5 rounded text-xs font-black bg-[#B29A1F] text-white border-[#B29A1F]">L3</span>
                            </div>
                            <div class="text-right">
                                <div class="font-mono font-black text-2xl text-[#B21F2C]">1,280</div>
                            </div>
                        </div>
                        <div class="pl-2">
                             <div class="flex justify-between text-xs text-slate-400 mb-1"><span>達成率</span><span>100%</span></div>
                             <div class="w-full h-4 bg-slate-200 rounded-full overflow-hidden mb-4 shadow-inner">
                                <div class="h-full bg-[#B29A1F] progress-bar-fill shadow-sm" style="width: 100%"></div>
                             </div>
                             <div class="flex justify-end">
                                <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-bold bg-green-100 text-green-700 ring-1 ring-green-600/20"><span class="w-1.5 h-1.5 mr-1.5 bg-green-500 rounded-full animate-pulse"></span>考核中</span>
                             </div>
                        </div>
                    </div>
                </div>
                `;

                // 3. 顯示注入的假資料，並隱藏讀取動畫
                document.getElementById('data-container').innerHTML = demoHTML;
                document.getElementById('loader').style.display = 'none';
                document.getElementById('data-container').classList.remove('opacity-0');
                
                // 4. 重要！標記已載入，直接 return 結束函式，絕對不去抓 CSV
                isDashboardLoaded = true;
                return;
            }

            // ============================================
            // 以下是「正式版」邏輯 (沒 demo 才會執行)
            // ============================================
            
            document.getElementById('data-cutoff-display').innerHTML = `<i class="fa-regular fa-clock mr-1"></i>資料統計至：${DATA_CUTOFF_DATE}`;
            const timeDisplay = document.getElementById('last-update');
            if(timeDisplay) timeDisplay.innerText = '系統連線時間：' + new Date().toLocaleString('zh-TW', { hour: '2-digit', minute: '2-digit' });
            
            const freshCsvUrl = csvUrl + "&nocache=" + Date.now();
            Papa.parse(freshCsvUrl, {
                download: true, header: true, skipEmptyLines: true,
                complete: function(results) {
                    if (results.data && results.data.length > 0) {
                        globalDashboardData = results.data;
                        renderDashboard(results.data);
                        document.getElementById('loader').style.display = 'none';
                        document.getElementById('data-container').classList.remove('opacity-0');
                        isDashboardLoaded = true;
                    } else { showError('讀取成功但沒有資料'); }
                },
                error: function(err) { showError('無法讀取資料'); }
            });
        }

        function filterData() {
            const input = document.getElementById('searchInput');
            const filter = input.value.toUpperCase();
            if(!globalDashboardData.length) return;
            const filteredData = globalDashboardData.filter(row => {
                return Object.values(row).some(val => String(val).toUpperCase().includes(filter));
            });
            renderDashboard(filteredData);
        }

        // 正式版渲染函式 (保持不變，會自動根據文字變色)
        function renderDashboard(data) {
            const container = document.getElementById('data-container');
            if(!container) return;
            
            if (data.length === 0) {
                container.innerHTML = `<div class="p-10 text-center text-slate-400 bg-white rounded-xl border border-dashed border-slate-300"><i class="fa-regular fa-folder-open text-4xl mb-3 block opacity-20"></i>沒有找到符合的資料</div>`;
                return;
            }

            const headers = Object.keys(data[0]);
            const colName = headers.find(h => h.includes('姓名') || h.includes('Name')) || headers[0];
            const colLevel = headers.find(h => h.includes('等級') || h.includes('職級') || h.includes('Level')) || '等級';
            const colStatus = headers.find(h => h.includes('狀態') || h.includes('Status')) || '狀態';
            let colHours = headers.find(h => h.includes('本職級') || h.includes('累積') && !h.includes('總'));
            if (!colHours) colHours = headers.find(h => h.includes('時數') && !h.includes('總')); 

            let tableHtml = `
                <div class="hidden md:block bg-white rounded-3xl shadow-lg border border-slate-100 overflow-hidden">
                <table class="min-w-full text-left text-sm whitespace-nowrap border-collapse">
                    <thead class="bg-slate-50 border-b border-slate-200 font-black text-slate-600 uppercase tracking-wider sticky top-0 z-10">
                        <tr>
                            <th class="px-6 py-5 pl-8">夥伴姓名</th>
                            <th class="px-6 py-5">目前等級 / 進度</th>
                            <th class="px-6 py-5 text-right text-brand-red">累積時數</th>
                            <th class="px-6 py-5 text-center">考核狀態</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-100">
            `;

            let cardsHtml = `<div class="grid grid-cols-1 gap-4 md:hidden">`;

            data.forEach(row => {
                if (!row[colName] || row[colName] === '姓名') return;
                
                const name = row[colName];
                const level = row[colLevel] ? row[colLevel].trim() : 'New'; 
                const hours = row[colHours] || '0'; 
                const status = row[colStatus] || '-';
                const numHours = parseFloat(hours.replace(/,/g, '')) || 0;
                
                let rowClass = "hover:bg-slate-50 transition-colors bg-white";
                let levelBadgeClass = "bg-slate-100 text-slate-500 border-slate-200"; 
                let nameColorClass = "text-slate-700"; 
                let progressBarColor = "bg-[#B21F2C]"; 
                let targetHours = 150; 

                if (level === 'L3') {
                    rowClass = "bg-amber-50 hover:bg-amber-100 transition-colors border-l-4 border-l-[#B29A1F]"; 
                    levelBadgeClass = "bg-[#B29A1F] text-white border-[#B29A1F] shadow-sm"; 
                    nameColorClass = "text-slate-900"; 
                    progressBarColor = "bg-[#B29A1F]"; 
                    targetHours = 600;
                } else if (level === 'L2') {
                    rowClass = "bg-slate-50 hover:bg-blue-50 transition-colors border-l-4 border-l-blue-400"; 
                    levelBadgeClass = "bg-blue-500 text-white border-blue-500 shadow-sm"; 
                    nameColorClass = "text-slate-800";
                    progressBarColor = "bg-[#3B82F6]"; 
                    targetHours = 300;
                }

                if (status.includes('覆核') || status.includes('維持') || status.includes('觀察')) {
                    targetHours = (level === 'L3' ? 300 : 100);
                }

                let progressPercent = Math.min((numHours / targetHours) * 100, 100);
                if (numHours < 0) progressPercent = 0;

                let statusHtml = '';
                if (status.includes('需評核') || status.includes('可考核') || status.includes('可晉升')) {
                    statusHtml = `<span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-bold bg-green-100 text-green-700 ring-1 ring-green-600/20"><span class="w-1.5 h-1.5 mr-1.5 bg-green-500 rounded-full animate-pulse"></span>考核中</span>`;
                } else if (status.includes('觀察') || status.includes('覆核') || status.includes('維持')) {
                    statusHtml = `<span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-bold bg-orange-100 text-orange-700 ring-1 ring-orange-600/20">覆核中</span>`;
                } else {
                    statusHtml = `<span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-bold bg-slate-100 text-slate-400">累積中</span>`;
                }

                tableHtml += `
                    <tr class="${rowClass} group">
                        <td class="px-6 py-4 pl-8 font-bold text-base ${nameColorClass}">${name}</td>
                        <td class="px-6 py-4">
                            <div class="flex items-center gap-3">
                                <span class="inline-block px-3 py-0.5 rounded-md border text-xs font-black tracking-wide ${levelBadgeClass}">${level}</span>
                                <div class="w-full max-w-[220px] h-4 bg-slate-200 rounded-full overflow-hidden shadow-inner">
                                    <div class="h-full ${progressBarColor} progress-bar-fill shadow-sm" style="width: ${progressPercent}%"></div>
                                </div>
                                <span class="text-xs text-slate-400 font-bold w-10">${Math.round(progressPercent)}%</span>
                            </div>
                        </td>
                        <td class="px-6 py-4 text-right">
                            <span class="font-mono font-black text-xl text-[#B21F2C] tracking-tight">${hours}</span>
                            <span class="text-xs text-slate-400 ml-1">/ ${targetHours}</span>
                        </td>
                        <td class="px-6 py-4 text-center">${statusHtml}</td>
                    </tr>
                `;

                cardsHtml += `
                    <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100 relative overflow-hidden">
                        ${level === 'L3' ? '<div class="absolute top-0 left-0 w-1 h-full bg-[#B29A1F]"></div>' : ''}
                        ${level === 'L2' ? '<div class="absolute top-0 left-0 w-1 h-full bg-blue-400"></div>' : ''}
                        <div class="flex justify-between items-start mb-4 pl-2">
                            <div>
                                <h3 class="font-bold text-lg ${nameColorClass}">${name}</h3>
                                <span class="inline-block mt-1 px-2 py-0.5 rounded text-xs font-black ${levelBadgeClass}">${level}</span>
                            </div>
                            <div class="text-right">
                                <div class="font-mono font-black text-2xl text-[#B21F2C]">${hours}</div>
                                <div class="text-xs text-slate-400">目標 ${targetHours} H</div>
                            </div>
                        </div>
                        <div class="pl-2">
                            <div class="flex justify-between text-xs text-slate-400 mb-1"><span>達成率</span><span>${Math.round(progressPercent)}%</span></div>
                            <div class="w-full h-4 bg-slate-200 rounded-full overflow-hidden mb-4 shadow-inner"><div class="h-full ${progressBarColor} progress-bar-fill shadow-sm" style="width: ${progressPercent}%"></div></div>
                            <div class="flex justify-end">${statusHtml}</div>
                        </div>
                    </div>
                `;
            });

            tableHtml += `</tbody></table></div>`;
            cardsHtml += `</div>`;
            container.innerHTML = tableHtml + cardsHtml;
        }

        function showError(msg) {
            const loader = document.getElementById('loader');
            if(loader) loader.innerHTML = `<div class="text-center text-red-500 font-bold px-4"><i class="fas fa-exclamation-triangle text-3xl mb-3 block"></i>${msg}</div>`;
        }
    </script>
